'use strict';(function(global){function defineSymbol(pPath,pSymbol,pRoot){if(!pRoot)pRoot=global;var tLastIndex=pPath.lastIndexOf("."),tName=pPath.substring(tLastIndex+1),tParts=pPath.substring(0,tLastIndex).split(/\./),tPart;while(tPart=tParts.shift())pRoot=pRoot[tPart]=pRoot[tPart]||new Object;if(pSymbol!==void 0)return pRoot[tName]=pSymbol;else if(pRoot[tName]!==void 0)return pRoot[tName];else return pRoot[tName]=new Object}var theatre=defineSymbol("theatre",new Object,global);if(Object.mixin===
void 0)Object.mixin=function(){var tObject=arguments[0]||new Object;for(var i=1,il=arguments.length;i<il;i++){var tArg=arguments[i];if(tArg)for(var k in tArg)if(tArg.hasOwnProperty(k)===true)tObject[k]=tArg[k]}return tObject};theatre.define=function(pName,pObject,pRoot){return defineSymbol(pName,pObject,pRoot)}})(this);(function(global){var Matrix=typeof CSSMatrix!=="undefined"?CSSMatrix:WebKitCSSMatrix;global.theatre.define("theatre.Matrix",Matrix)})(this);
(function(global){var theatre=global.theatre,Matrix=theatre.Matrix,max=global.Math.max;theatre.define("theatre.Actor",Actor);theatre.define("theatre.createActor",createActor);function Actor(){}function addScriptToScene(pSceneName,pStep,pScript,pType){var tScene;if(!pSceneName)pSceneName="";pStep=this.stage.timeToStep(pStep);if(pSceneName in this._scenes)tScene=this._scenes[pSceneName].scripts[pType];else{tScene=this._scenes[pSceneName]={name:pSceneName,isActing:false,currentStep:-1,previousStep:-2,
shouldLoop:true,scripts:[new Array,new Array]};tScene=tScene.scripts[pType]}if(tScene.length<=pStep)tScene[pStep]=[pScript];else tScene[pStep].push(pScript)}function executeScripts(pContext,pScripts,pStep){if(pScripts[pStep]!==void 0){var tScriptStep=pScripts[pStep];for(var i=0,il=tScriptStep.length;i<il;i++)tScriptStep[i].call(pContext)}}Actor.prototype={initialize:function(pData,pStage,pLayer,pParent,pName){this.stage=pStage;this.matrix=new Matrix;this.layer=pLayer;this.parent=pParent;this.name=
pName;this.isActing=false;this.isInvalidated=false;this._currentScene={name:"",isActing:true,currentStep:-1,previousStep:-2,shouldLoop:true,scripts:[new Array,new Array]};this._scenes={"":this._currentScene};this._layerCounter=0},listen:function(pName,pCallback){if("_cues"in this===false)this._cues=new Object;if(pName in this._cues===false){this._cues[pName]=[pCallback];this.stage.registerListener(pName,this)}else this._cues[pName].push(pCallback);return this},ignore:function(pName,pCallback){if("_cues"in
this&&pName in this._cues){var tCues=this._cues[pName];for(var i=0,il=tCues.length;i<il;i++)if(tCues[i]===pCallback){tCues.splice(i,1);break}if(tCues.length===0){delete this._cues[pName];this.stage.unregisterListener(pName,this)}}return this},cue:function(pName,pData){if("_cues"in this&&pName in this._cues){var tCallbacks=this._cues[pName].slice(0);for(var i=0,il=tCallbacks.length;i<il;i++)tCallbacks[i].call(this,{target:this,data:pData,name:pName})}return this},invalidate:function(){if(this.isInvalidated===
true)return;this.isInvalidated=true;this.stage.invalidate(this);return this},addPreparationScript:function(pStep,pScript,pSceneName){addScriptToScene.call(this,pSceneName,pStep,pScript,0);return this},addScript:function(pStep,pScript,pSceneName){addScriptToScene.call(this,pSceneName,pStep,pScript,1);return this},doScripts:function(pStep,pContext,pSceneParam){var tScenes=this._scenes,tScene=this._currentScene;if(!pSceneParam)tScene=this._currentScene;else if(typeof pSceneParam==="string"){if(pSceneParam in
tScenes===false)throw new Error("Scene doesn't exist: "+pSceneParam);tScene=tScenes[pSceneParam]}if(typeof pStep!=="number")pStep=tScene.currentStep;if(pContext===void 0)pContext=this;executeScripts(pContext,tScene.scripts[1],pStep)},startActing:function(){this.stage.activateActor(this);this.isActing=true;return this},stopActing:function(){this.stage.deactivateActor(this);this.isActing=false;return this},gotoInScene:function(pSceneName,pStep){if(pSceneName in this._scenes===false)throw new Error("Scene doesn't exist: "+
pSceneName);this.startActingScene(pSceneName);var tScene=this._currentScene;pStep=this.stage.timeToStep(pStep);this.step(pStep-tScene.currentStep,false);return this},startActingScene:function(pSceneName){if(pSceneName in this._scenes===false)throw new Error("Scene doesn't exist: "+pSceneName);if(this._currentScene.name===pSceneName)return;this._currentScene.isActing=false;var tScene=this._scenes[pSceneName];tScene.isActing=true;this._currentScene=tScene;return this},act:function(){},step:function(pDelta,
pPreparedScriptsOnly){var tStage=this.stage,tScene=this._currentScene;if(tScene.isActing===false)return;var tPreviousStep=tScene.currentStep,tScripts=tScene.scripts,tLength=max(tScripts[0].length,tScripts[1].length),tCurrentStep=tScene.currentStep+=pDelta,tLooped=false;if(tCurrentStep>=tLength){if(tScene.shouldLoop===false||tLength===1){tScene.currentStep=tLength-1;return}tCurrentStep=tScene.currentStep-=tLength;tPreviousStep=-1;tLooped=true}tScene.previousStep=tPreviousStep;if(tPreviousStep===tCurrentStep){if(tLooped===
true&&!pPreparedScriptsOnly){executeScripts(this,tScripts[0],tCurrentStep);executeScripts(this,tScripts[1],tCurrentStep)}}else if(pDelta<0||tLooped===true){if(tLooped===true)this.cue("sceneloop");for(var i=0,il=tCurrentStep;i<=il;i++){tScene.currentStep=i;executeScripts(this,tScripts[0],i)}}else for(var i=tPreviousStep+1,il=tCurrentStep;i<=il;i++){tScene.currentStep=i;executeScripts(this,tScripts[0],i)}if(!pPreparedScriptsOnly)executeScripts(this,tScripts[1],tCurrentStep);if(!pPreparedScriptsOnly)this.cue("update")},
addActor:function(pClazz,pOptions){pOptions=pOptions||new Object;var tLayer=typeof pOptions.layer==="number"?pOptions.layer:this._layerCounter++,tActors;if("_actors"in this===false)tActors=this._actors=new Array(tLayer+1);else tActors=this._actors;if(tActors[tLayer]!==void 0)throw new Error("Actor already exists at layer "+tLayer);var tActor=new pClazz;var tName=typeof pOptions.name==="string"?pOptions.name:"instance"+this.stage._actorNameCounter++;tActors[tLayer]=tActor;tActor.initialize(pOptions,
this.stage,tLayer,this,tName);tActor.cue("enter");tActor.startActing();return tActor},getActors:function(){var tResult=new Array,tActors=this._actors;if(!tActors)return new Array(0);for(var i=0,il=tActors.length;i<il;i++)if(tActors[i]!==void 0)tResult.push(tActors[i]);return tResult},getActorAtLayer:function(pLayer){if("_actors"in this===false)return null;return this._actors[pLayer]||null},findActors:function(pQuery){throw new Error("Not implemented");},leave:function(){if(this.parent===null)return;
if(this.parent._actors[this.layer]!==this)return;this.cue("leave");this.stage.deactivateActor(this);this.parent._actors[this.layer]=void 0;this.parent=null},get x(){return this.matrix.e},set x(pValue){this.matrix.e=pValue},get y(){return this.matrix.f},set y(pValue){this.matrix.f=pValue},get rotation(){return this._rotation},set rotation(pValue){this._rotation=pValue;this.matrix=this.matrix.rotateAxisAngle(0,0,0,pValue)},get scaleX(){return this.matrix.a},set scaleX(pValue){this.matrix=this.matrix.scale(pValue,
0)},get scaleY(){return this.matrix.d},set scaleY(pValue){this.matrix=this.matrix.scale(0,pValue)}};function createActor(pName,pExtends,pInitializer){if(!pExtends)pExtends=theatre.Actor;var tClazz=global.eval("(function "+pName+"(){})"),tPrototype=tClazz.prototype=new pExtends,tSuperInitialize=tPrototype.initialize;tPrototype.initialize=function(){tSuperInitialize.apply(this,arguments);if(pInitializer)pInitializer.apply(this,arguments)};return tClazz}})(this);
(function(global){var theatre=global.theatre;var StageManager=theatre.createActor("StageManager");theatre.define("theatre.StageManager",StageManager)})(this);
(function(global){var theatre=global.theatre;theatre.define("theatre.Stage",Stage);var mRequestAnimationFrame=global.webkitRequestAnimationFrame!==void 0?global.webkitRequestAnimationFrame:null;function tickCallback(pStage){var tTime=Date.now();pStage.step();if(pStage.isOpen)pStage.timer=setTimeout(tickCallback,pStage.stepRate-(Date.now()-tTime),pStage)}var mTimeToStepRegex=/^([\d]+)(ms|[sm])$/;function Stage(pOptions){this._timer=null;this._animationFrameId=null;this._actingActors=new Array;this._listeners=
new Object;this._invalidatedActors=new Array;this._actorNameCounter=1;this.stepRate=1E3/30;this.isOpen=false;var tStageManager;Object.defineProperty(this,"stageManager",{get:function(){return tStageManager},set:function(pValue){tStageManager=pValue;pValue.initialize(null,this);pValue.isActing=true;this.activateActor(pValue,true)}});this.stageManager=new theatre.StageManager}function actActors(){this._animationFrameId=null;var tInvalidated=this._invalidatedActors;for(var i=0,il=tInvalidated.length;i<
il;i++){var tActor=tInvalidated[i];tActor.act();tActor.isInvalidated=false}tInvalidated.length=0}Stage.prototype={timeToStep:function(pTime){if(typeof pTime==="number")return pTime;var tResult=mTimeToStepRegex.exec(pTime);if(tResult===null)throw new Error("Bad time string");switch(tResult[2]){case "ms":return tResult[1]/this.stepRate|0;case "s":return tResult[1]*1E3/this.stepRate|0;case "m":return tResult[1]*60*1E3/this.stepRate|0}},open:function(){if(this.isOpen)return;this.isOpen=true;this.timer=
setTimeout(tickCallback,this.stepRate,this);return this},close:function(){if(!this.isOpen)return;clearTimeout(this.timer);this.timer=null;this.isOpen=false;return this},addActor:function(pClazz,pOptions){return this.stageManager.addActor(pClazz,pOptions)},invalidate:function(pActor){this._invalidatedActors.push(pActor)},step:function(){var i,il,tActingActors;this.cue("enterstep");var tActingActorDepths=this._actingActors.slice(0),tDepth,tIndex=tDepth=tActingActorDepths.length;while(tIndex--!==0){tActingActors=
tActingActorDepths[tIndex];if(!tActingActors)continue;for(i=0,il=tActingActors.length;i<il;i++)tActingActors[i].step(1,true)}tIndex=tDepth;while(tIndex--!==0){tActingActors=tActingActorDepths[tIndex];if(!tActingActors)continue;for(i=0,il=tActingActors.length;i<il;i++)tActingActors[i].doScripts()}this.cue("update");if(this._animationFrameId===null&&this._invalidatedActors.length!==0)if(mRequestAnimationFrame!==null)this._animationFrameId=mRequestAnimationFrame(function(pContext){return function(){actActors.call(pContext)}}(this));
else{this._animationFrameId=1;actActors.call(this)}this.cue("leavestep")},activateActor:function(pActor,pNoStep){var tParent=pActor.parent,tDepth=0;while(tParent!=null){tDepth++;tParent=tParent.parent}var tActingActors=this._actingActors;if(tActingActors.length<=tDepth)tActingActors=tActingActors[tDepth]=new Array;else tActingActors=tActingActors[tDepth];if(tActingActors.indexOf(pActor)===-1){tActingActors.push(pActor);if(!pNoStep)pActor.step(1)}},deactivateActor:function(pActor){var tParent=pActor.parent,
tDepth=0;while(tParent!=null){tDepth++;tParent=tParent.parent}var tActingActors=this._actingActors;if(tActingActors[tDepth]===void 0)return;var i=tActingActors[tDepth].indexOf(pActor);if(i>=0)tActingActors[tDepth].splice(i,1)},setBackground:function(pBackground){this.background=pBackground},registerListener:function(pName,pListener){if(!(pName in this._listeners))this._listeners[pName]=[pListener];else this._listeners[pName].push(pListener)},unregisterListener:function(pName,pListener){if(pName in
this._listeners){var tListeners=this._listeners[pName];for(var i=0,il=tListeners.length;i<il;i++)if(tListeners[i]===pListener){tListeners.splice(i,1);break}if(tListeners.length===0)delete this._listeners[pName]}},cue:function(pName,pData){if(pName in this._listeners){var tListeners=this._listeners[pName].slice(0);for(var i=0,il=tListeners.length;i<il;i++)tListeners[i].cue(pName,pData)}}}})(this);(function(global){var theatre=global.theatre;function onEnter(){var tElement=this.element=this.elementTemplate.cloneNode(true),tStyle=tElement.style,tProtoStyles=this.styles;tStyle.zIndex=this.layer;tStyle.width=typeof this.width==="string"?this.width:this.width+"px";tStyle.height=typeof this.height==="string"?this.height:this.height+"px";if(tProtoStyles!==null)for(var tKey in tProtoStyles)tStyle[tKey]=tProtoStyles[tKey];this.invalidate()}function onLeave(){if(this.element.parentNode!==null)this.element.parentNode.removeChild(this.element)}
var DOMActor=theatre.createActor("DOMActor",theatre.Actor,function(pData){this.styles=pData.styles||null;this.width=pData.width||"auto";this.height=pData.height||"auto";this.container=pData.container||global.document.body;this.listen("enter",onEnter);this.listen("leave",onLeave)});Object.defineProperties(DOMActor.prototype,{elementTemplate:{value:document.createElement("div")},act:{value:function(){var tElement=this.element,tMatrix=this.matrix;tElement.style.webkitTransform="matrix3d("+tMatrix.a+
","+tMatrix.b+",0,0,"+tMatrix.c+","+tMatrix.d+",0,0,0,0,1,0,"+tMatrix.e+","+tMatrix.f+",0,1)";if(!this.hasParentNode){this.hasParentNode=true;if(this.parent instanceof DOMActor)this.parent.element.appendChild(tElement);else this.container.appendChild(tElement)}}}});theatre.define("theatre.crews.dom.DOMActor",DOMActor)})(this);(function(global){var theatre=global.theatre;function onEnter(){var tCanvas=global.document.createElement("canvas");tCanvas.width=this.width||this.parent.width||1;tCanvas.height=this.height||this.parent.height||1;this.context=tCanvas.getContext("2d");this.invalidate()}var CanvasActor=theatre.createActor("CanvasActor",theatre.Actor,function(pData){this.width=pData.width||0;this.height=pData.height||0;this.context=null;this.listen("enter",onEnter)});var invalidateBackup=theatre.Actor.prototype.invalidate;
Object.defineProperties(CanvasActor.prototype,{draw:{value:function(pContext){pContext.clearRect(0,0,this.width,this.height)}},getDrawResult:{value:function(){var tCtx=this.context;if(this.isInvalidated!==true)return tCtx.canvas;tCtx.save();this.draw(tCtx);tCtx.restore();var tActors=this.getActors();for(var i=0,il=tActors.length;i<il;i++){var tActor=tActors[i],tMatrix=tActor.matrix;var tResult=tActor.getDrawResult!==void 0?tActor.getDrawResult():null;if(tResult!==null){tCtx.save();tCtx.transform(tMatrix.a,
tMatrix.b,tMatrix.c,tMatrix.d,tMatrix.e,tMatrix.f);tCtx.drawImage(tResult,0,0);tCtx.restore()}}return tCtx.canvas}},act:{value:function(){var tCanvas=this.getDrawResult();if(this.isAdded!==true){this.isAdded=true;if(theatre.crews.dom&&this.parent instanceof theatre.crews.dom.DOMActor){tCanvas.style.zIndex=this.layer;this.parent.element.appendChild(tCanvas)}}}},invalidate:{value:function(){invalidateBackup.call(this);if(this.parent)this.parent.invalidate()}}});theatre.define("theatre.crews.canvas.CanvasActor",
CanvasActor)})(this);

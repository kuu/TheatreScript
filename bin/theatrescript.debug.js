'use strict';function use(){};/*
 TheatreScript
 Copyright (C) 2012 Jason Parrott.
 This code is licensed under the zlib license.
 See the LICENSE file in the original source for details.
*/
(function(e){function g(d,b,a){a||(a=e);for(var c=d.lastIndexOf("."),h=d.substring(c+1),d=d.substring(0,c).split(/\./);c=d.shift();)a=a[c]=a[c]||{};if(void 0!==b)a[h]=b;else return a;return b}var i=g("theatre",{},e);void 0===Object.mixin&&(Object.mixin=function(){for(var d=arguments[0]||{},b=1,a=arguments.length;b<a;b++){var c=arguments[b];if(c)for(var h in c)!0===c.hasOwnProperty(h)&&(d[h]=c[h])}return d});i.define=function(d,b,a){g(d,b,a);return i}})(this);use("Theatre");(function(e){e.theatre.define("theatre.Matrix","undefined"!==typeof CSSMatrix?CSSMatrix:WebKitCSSMatrix)})(this);use("Theatre","Matrix");
(function(e){function g(){}function i(h,a,f,c){a=this.stage.timeToStep(a);h in this._scenes?h=this._scenes[h].scripts[c]:(h=this._scenes[h]={isActing:!1,currentStep:0,previousStep:-1,shouldLoop:!0,scripts:[[],[]]},h=h.scripts[c]);h.length<=a?h[a]=[f]:h[a].push(f)}function d(h,a){if(void 0!==h[a])for(var f=h[a],c=0,b=f.length;c<b;c++)f[c].call(this)}var b=e.theatre,a=b.Matrix,c=e.Math.max;b.define("theatre.Actor",g);b.define("theatre.createActor",function(h,a,f){a||(a=b.Actor);var h=e.eval("(function "+
h+"(){})"),a=h.prototype=new a,c=a.initialize;void 0!==f&&(a.initialize=function(){c.apply(this,arguments);f.apply(this,arguments)});return h});g.prototype={initialize:function(h,j,c,l,b){this.stage=j;this.matrix=new a;this.layer=c;this.parent=l;this.name=b;this.isInvalidated=this.isActing=!1;this._scenes={};this._layerCounter=0},listen:function(a,j){!1==="_cues"in this&&(this._cues={});!1===a in this._cues?(this._cues[a]=[j],this.stage.registerListener(a,this)):this._cues[a].push(j);return this},
ignore:function(a,j){if("_cues"in this&&a in this._cues){for(var c=this._cues[a],b=0,d=c.length;b<d;b++)if(c[b]===j){c.splice(b,1);break}0===c.length&&(delete this._cues[a],this.stage.unregisterListener(a,this))}return this},cue:function(a,c){if("_cues"in this&&a in this._cues)for(var f=this._cues[a].slice(0),b=0,d=f.length;b<d;b++)f[b].call(this,{target:this,data:c,name:a});return this},invalidate:function(){if(!0!==this.isInvalidated)return this.isInvalidated=!0,this.stage.invalidate(this),this},
addPreparationScript:function(a,c){i.call(this,pSceneName,a,c,0);return this},addScript:function(a,c,f){i.call(this,a,c,f,1);return this},doScripts:function(a,c,f){function b(){"number"!==typeof c&&(c=tScene.currentStep);void 0===f&&(f=this);d(f,tScene.scripts[1],c)}var e=this._scenes;if(a){if("string"===typeof a){if(!1===a in e)throw Error("Scene doesn't exist: "+a);b(e[a].scripts[1])}}else for(tName in e)b(e[tName].scripts[1])},startActing:function(){this.stage.activateActor(this);this.isActing=
!0;return this},stopActing:function(){this.stage.deactivateActor(this);this.isActing=!1;return this},gotoInScene:function(a,c){if(!1===a in this._scenes)throw Error("Scene doesn't exist: "+a);var f=this._scenes[a],c=this.stage.timeToStep(c);this.step(c-f.currentStep,f,!1);return this},startActingScene:function(a){if(!1===a in this._scenes)throw Error("Scene doesn't exist: "+a);this._scenes[a].isActing=!0;return this},stopActingScene:function(a){if(!1===a in this._scenes)throw Error("Scene doesn't exist: "+
a);this._scenes[a].isActing=!1;return this},act:function(){},step:function(a,b,f){function e(b){if(!1!==b.isActing){var j=b.currentStep,l=b.scripts,g=c(l[0].length,l[1].length),k=b.currentStep+=a,m=!1;if(k>=g){if(!1===i.shouldLoop||1===g){b.currentStep=g-1;return}k=b.currentStep-=g;m=!0}if(j===k)!0===m&&!f&&(d(i,pScripts[0],k),d(i,pScripts[1],k));else{if(!(0>a||!0===m)){j+=1;for(g=k;j<=g;j++)b.currentStep=j,d(i,l[0],j)}f||d(i,l[1],k)}}}var i=this,g=this._scenes;if(b){if("string"===typeof b){if(!1===
b in g)throw Error("Scene doesn't exist: "+b);e(g[b])}}else for(tName in g)e(g[tName]);f||this.cue("update")},addActor:function(a,c){var c=Object.mixin({data:null},c),b="number"===typeof c.layer?c.layer:this._layerCounter++,e;e=!1==="_actors"in this?this._actors=Array(b+1):this._actors;if(void 0!==e[b])throw Error("Actor already exists at layer "+b);var d=new a,g="string"!==typeof c.name?c.name:"instance"+tStage._actorNameCounter++;d.initialize(c.data,this.stage,b,this,g);e[b]=d;d.cue("enter");return d},
getActors:function(){var a=[],c=this._actors;if(!c)return[];for(var b=0,d=c.length;b<d;b++)void 0!==c[b]&&a.push(c[b]);return a},findActors:function(){throw Error("Not implemented");},leave:function(){null!==this.parent&&this.parent._actors[this.layer]===this&&(this.cue("leave"),this.stage.deactivateActor(this),this.parent._actors[this.layer]=void 0)},get x(){return this.matrix.e},set x(a){this.matrix.e=a},get y(){return this.matrix.f},set y(a){this.matrix.f=a},get rotation(){return this._rotation},
set rotation(a){this._rotation=a;this.matrix=this.matrix.rotateAxisAngle(0,0,0,a)},get scaleX(){return this.matrix.a},set scaleX(a){this.matrix=this.matrix.scale(a,0)},get scaleY(){return this.matrix.d},set scaleY(a){this.matrix=this.matrix.scale(0,a)}}})(this);use("Theatre","Actor");(function(e){var e=e.theatre,g=e.createActor("StageManager");e.define("theatre.StageManager",g)})(this);use("Theatre","Actor");
(function(e){function g(){var a=e.document.createElement("canvas");a.width=this.width||1;a.height=this.height||1;this.context=a.getContext("2d");this.invalidate()}var i=e.theatre,d=i.createActor("CanvasActor",i.Actor,function(a){this.width=a.width||0;this.height=a.height||0;this.context=null;this.listen("enter",g)}),b=i.Actor.prototype.invalidate;Object.defineProperties(d.prototype,{draw:{value:function(a){a.clearRect(0,0,this.width,this.height)}},getDrawResult:{value:function(){var a=this.context;
if(!0!==this.isInvalidated)return a.canvas;a.save();this.draw(a);a.restore();for(var c=this.getActors(),b=0,d=c.length;b<d;b++){var f=c[b],e=f.matrix,f=void 0!==f.getDrawResult?f.getDrawResult():null;null!==f&&(a.save(),a.transform(e.a,e.b,e.c,e.d,e.e,e.f),a.drawImage(f,0,0),a.restore())}return a.canvas}},act:{value:function(){var a=this.getDrawResult();!0!==this.isAdded&&(this.isAdded=!0,i.crews.dom&&this.parent instanceof i.crews.dom.DOMActor&&(a.style.zIndex=this.layer,this.parent.element.appendChild(a)))}},
invalidate:{value:function(){b.call(this);this.parent.invalidate()}}});i.define("theatre.crews.canvas.CanvasActor",d)})(this);use("Theatre","Actor");
(function(e){function g(){var b=(this.element=this.elementTemplate.cloneNode(!0)).style,a=this.styles;b.zIndex=this.layer;b.width="string"===typeof this.width?this.width:this.width+"px";b.height="string"===typeof this.height?this.height:this.height+"px";if(null!==a)for(var c in a)b[c]=a[c];this.invalidate()}var i=e.theatre,d=i.createActor("DOMActor",i.Actor,function(b){this.styles=b.styles||null;this.width=b.width||0;this.height=b.height||0;this.container=b.container||e.document.body;this.listen("enter",
g)});Object.defineProperties(d.prototype,{elementTemplate:{value:document.createElement("div")},act:{value:function(){var b=this.element,a=this.matrix;b.style.webkitTransform="matrix3d("+a.a+","+a.b+",0,0,"+a.c+","+a.d+",0,0,0,0,1,0,"+a.e+","+a.f+",0,1)";this.hasParentNode||(this.hasParentNode=!0,this.parent instanceof d?this.parent.element.appendChild(b):this.container.appendChild(b))}}});i.define("theatre.crews.dom.DOMActor",d)})(this);use("Theatre","StageManager");
(function(e){function g(a){var c=Date.now();a.step();a.isOpen&&(a.timer=setTimeout(g,a.stepRate-(Date.now()-c),a))}function i(){this._animationFrameId=this._timer=null;this._actingActors=[];this._listeners={};this._invalidatedActors=[];this._actorNameCounter=1;this.stepRate=1E3/30;this.isOpen=!1;var a;Object.defineProperty(this,"stageManager",{get:function(){return a},set:function(c){a=c;c.initialize(null,this);c.isActing=!0;this.activateActor(c,!0)}});this.stageManager=new d.StageManager}var d=e.theatre;
d.define("theatre.Stage",i);var b=/^([\d]+)(ms|[sm])$/;i.prototype={timeToStep:function(a){if("number"===typeof a)return a;a=b.exec(a);if(null===a)throw Error("Bad time string");switch(a[2]){case "ms":return a[1]/this.stepRate|0;case "s":return 1E3*a[1]/this.stepRate|0;case "m":return 6E4*a[1]/this.stepRate|0}},open:function(){this.isOpen=!0;this.timer=setTimeout(g,this.stepRate,this);return this},close:function(){clearTimeout(this.timer);this.timer=null;this.isOpen=!1;return this},invalidate:function(a){this._invalidatedActors.push(a)},
step:function(){var a,c,b;this.cue("enterstep");for(var d=this._actingActors.slice(0),f,g=f=d.length;0!==g--;){b=d[g];a=0;for(c=b.length;a<c;a++)b[a].step(1,null,!0)}for(g=f;0!==g--;){b=d[g];a=0;for(c=b.length;a<c;a++)b[a].doScripts()}this.cue("update");null===this._animationFrameId&&0!==this._invalidatedActors.length&&(this._animationFrameId=e.webkitRequestAnimationFrame(function(a){return function(){a._animationFrameId=null;for(var c=a._invalidatedActors,b=0,h=c.length;b<h;b++){var d=c[b];d.act();
d.isInvalidated=!1}c.length=0}}(this)));this.cue("leavestep")},activateActor:function(a,c){for(var b=a.parent,d=0;null!=b;)d++,b=b.parent;b=this._actingActors;b=b.length<=d?b[d]=[]:b[d];-1===b.indexOf(a)&&(b.push(a),c||a.step(1))},deactivateActor:function(a){for(var b=pReel.parent,d=0;null!=b;)d++,b=b.parent;b=this._actingActors;void 0!==b[d]&&(a=b[d].indexOf(a),0<=a&&b.splice(a,1))},setBackground:function(a){this.background=a},registerListener:function(a,b){a in this._listeners?this._listeners[a].push(b):
this._listeners[a]=[b]},unregisterListener:function(a,b){if(a in this._listeners){for(var d=this._listeners[a],e=0,f=d.length;e<f;e++)if(d[e]===b){d.splice(e,1);break}0===d.length&&delete this._listeners[a]}},cue:function(a,b){if(a in this._listeners)for(var d=this._listeners[a].slice(0),e=0,f=d.length;e<f;e++)d[e].cue(a,b)}}})(this);

'use strict';(function(f){function j(i,e,d){d||(d=f);for(var k=i.lastIndexOf("."),a=i.substring(k+1),i=i.substring(0,k).split(/\./);k=i.shift();)d=d[k]=d[k]||{};if(void 0!==e)d[a]=e;else return d;return e}var h=j("theatre",{},f);void 0===Object.mixin&&(Object.mixin=function(){for(var i=arguments[0]||{},e=1,d=arguments.length;e<d;e++){var f=arguments[e];if(f)for(var a in f)!0===f.hasOwnProperty(a)&&(i[a]=f[a])}return i});h.define=function(f,e,d){j(f,e,d);return h}})(this);
(function(f){f.theatre.define("theatre.Matrix","undefined"!==typeof CSSMatrix?CSSMatrix:WebKitCSSMatrix)})(this);
(function(f){function j(){}function h(a,c,b,g){a||(a="");c=this.stage.timeToStep(c);a in this._scenes?a=this._scenes[a].scripts[g]:(a=this._scenes[a]={name:a,isActing:!1,currentStep:0,previousStep:-1,shouldLoop:!0,scripts:[[],[]]},a=a.scripts[g]);a.length<=c?a[c]=[b]:a[c].push(b)}function i(a,c,b){if(void 0!==c[b])for(var c=c[b],b=0,g=c.length;b<g;b++)c[b].call(a)}var e=f.theatre,d=e.Matrix,k=f.Math.max;e.define("theatre.Actor",j);e.define("theatre.createActor",function(a,c,b){c||(c=e.Actor);var a=
f.eval("(function "+a+"(){})"),c=a.prototype=new c,g=c.initialize;void 0!==b&&(c.initialize=function(){g.apply(this,arguments);b.apply(this,arguments)});return a});j.prototype={initialize:function(a,c,b,g,e){this.stage=c;this.matrix=new d;this.layer=b;this.parent=g;this.name=e;this.isInvalidated=this.isActing=!1;this._currentScene={name:"",isActing:!1,currentStep:0,previousStep:-1,shouldLoop:!0,scripts:[[],[]]};this._scenes={"":this._currentScene};this._layerCounter=0},listen:function(a,c){!1==="_cues"in
this&&(this._cues={});!1===a in this._cues?(this._cues[a]=[c],this.stage.registerListener(a,this)):this._cues[a].push(c);return this},ignore:function(a,c){if("_cues"in this&&a in this._cues){for(var b=this._cues[a],g=0,d=b.length;g<d;g++)if(b[g]===c){b.splice(g,1);break}0===b.length&&(delete this._cues[a],this.stage.unregisterListener(a,this))}return this},cue:function(a,c){if("_cues"in this&&a in this._cues)for(var b=this._cues[a].slice(0),g=0,d=b.length;g<d;g++)b[g].call(this,{target:this,data:c,
name:a});return this},invalidate:function(){if(!0!==this.isInvalidated)return this.isInvalidated=!0,this.stage.invalidate(this),this},addPreparationScript:function(a,c,b){h.call(this,b,a,c,0);return this},addScript:function(a,c,b){h.call(this,b,a,c,1);return this},doScripts:function(a,c,b){var g=this._scenes,d=this._currentScene;if(b){if("string"===typeof b){if(!1===b in g)throw Error("Scene doesn't exist: "+b);d=g[b]}}else d=this._currentScene;"number"!==typeof a&&(a=d.currentStep);void 0===c&&(c=
this);i(c,d.scripts[1],a)},startActing:function(){this.stage.activateActor(this);this.isActing=!0;return this},stopActing:function(){this.stage.deactivateActor(this);this.isActing=!1;return this},gotoInScene:function(a,c){if(!1===a in this._scenes)throw Error("Scene doesn't exist: "+a);this.startActingScene(a);var b=this._currentScene,c=this.stage.timeToStep(c);this.step(c-b.currentStep,!1);return this},startActingScene:function(a){if(!1===a in this._scenes)throw Error("Scene doesn't exist: "+a);
if(this._currentScene.name!==a)return this._currentScene.isActing=!1,a=this._scenes[a],a.isActing=!0,this._currentScene=a,this},act:function(){},step:function(a,c){var b=this._currentScene;if(!1!==b.isActing){var g=b.currentStep,d=b.scripts,e=k(d[0].length,d[1].length),f=b.currentStep+=a,h=!1;if(f>=e){if(!1===this.shouldLoop||1===e){b.currentStep=e-1;return}f=b.currentStep-=e;h=!0}if(g===f)!0===h&&!c&&(i(this,d[0],f),i(this,d[1],f));else{if(0>a||!0===h)throw Error("pDelta is less than 0 or we looped");
g+=1;for(e=f;g<=e;g++)b.currentStep=g,i(this,d[0],g)}c||i(this,d[1],f);c||this.cue("update")}},addActor:function(a,c){var c=Object.mixin({data:{}},c),b="number"===typeof c.layer?c.layer:this._layerCounter++,d;d=!1==="_actors"in this?this._actors=Array(b+1):this._actors;if(void 0!==d[b])throw Error("Actor already exists at layer "+b);var e=new a,f="string"!==typeof c.name?c.name:"instance"+tStage._actorNameCounter++;e.initialize(c.data,this.stage,b,this,f);d[b]=e;e.cue("enter");return e},getActors:function(){var a=
[],c=this._actors;if(!c)return[];for(var b=0,d=c.length;b<d;b++)void 0!==c[b]&&a.push(c[b]);return a},findActors:function(){throw Error("Not implemented");},leave:function(){null!==this.parent&&this.parent._actors[this.layer]===this&&(this.cue("leave"),this.stage.deactivateActor(this),this.parent._actors[this.layer]=void 0)},get x(){return this.matrix.e},set x(a){this.matrix.e=a},get y(){return this.matrix.f},set y(a){this.matrix.f=a},get rotation(){return this._rotation},set rotation(a){this._rotation=
a;this.matrix=this.matrix.rotateAxisAngle(0,0,0,a)},get scaleX(){return this.matrix.a},set scaleX(a){this.matrix=this.matrix.scale(a,0)},get scaleY(){return this.matrix.d},set scaleY(a){this.matrix=this.matrix.scale(0,a)}}})(this);(function(f){var f=f.theatre,j=f.createActor("StageManager");f.define("theatre.StageManager",j)})(this);
(function(f){function j(a){var c=Date.now();a.step();a.isOpen&&(a.timer=setTimeout(j,a.stepRate-(Date.now()-c),a))}function h(){this._animationFrameId=this._timer=null;this._actingActors=[];this._listeners={};this._invalidatedActors=[];this._actorNameCounter=1;this.stepRate=1E3/30;this.isOpen=!1;var a;Object.defineProperty(this,"stageManager",{get:function(){return a},set:function(c){a=c;c.initialize(null,this);c.isActing=!0;this.activateActor(c,!0)}});this.stageManager=new e.StageManager}function i(){this._animationFrameId=
null;for(var a=this._invalidatedActors,c=0,b=a.length;c<b;c++){var d=a[c];d.act();d.isInvalidated=!1}a.length=0}var e=f.theatre;e.define("theatre.Stage",h);var d=void 0!==f.webkitRequestAnimationFrame?f.webkitRequestAnimationFrame:null,k=/^([\d]+)(ms|[sm])$/;h.prototype={timeToStep:function(a){if("number"===typeof a)return a;a=k.exec(a);if(null===a)throw Error("Bad time string");switch(a[2]){case "ms":return a[1]/this.stepRate|0;case "s":return 1E3*a[1]/this.stepRate|0;case "m":return 6E4*a[1]/this.stepRate|
0}},open:function(){this.isOpen=!0;this.timer=setTimeout(j,this.stepRate,this);return this},close:function(){clearTimeout(this.timer);this.timer=null;this.isOpen=!1;return this},invalidate:function(a){this._invalidatedActors.push(a)},step:function(){var a,c,b;this.cue("enterstep");for(var g=this._actingActors.slice(0),e,f=e=g.length;0!==f--;){b=g[f];a=0;for(c=b.length;a<c;a++)b[a].step(1,!0)}for(f=e;0!==f--;){b=g[f];a=0;for(c=b.length;a<c;a++)b[a].doScripts()}this.cue("update");if(null===this._animationFrameId&&
0!==this._invalidatedActors.length)if(null!==d){var h=this;this._animationFrameId=d(function(){i.call(h)})}else this._animationFrameId=1,i.call(this);this.cue("leavestep")},activateActor:function(a,c){for(var b=a.parent,d=0;null!=b;)d++,b=b.parent;b=this._actingActors;b=b.length<=d?b[d]=[]:b[d];-1===b.indexOf(a)&&(b.push(a),c||a.step(1))},deactivateActor:function(a){for(var c=pReel.parent,b=0;null!=c;)b++,c=c.parent;c=this._actingActors;void 0!==c[b]&&(a=c[b].indexOf(a),0<=a&&c.splice(a,1))},setBackground:function(a){this.background=
a},registerListener:function(a,c){a in this._listeners?this._listeners[a].push(c):this._listeners[a]=[c]},unregisterListener:function(a,c){if(a in this._listeners){for(var b=this._listeners[a],d=0,e=b.length;d<e;d++)if(b[d]===c){b.splice(d,1);break}0===b.length&&delete this._listeners[a]}},cue:function(a,c){if(a in this._listeners)for(var b=this._listeners[a].slice(0),d=0,e=b.length;d<e;d++)b[d].cue(a,c)}}})(this);(function(f){function j(){var e=(this.element=this.elementTemplate.cloneNode(!0)).style,d=this.styles;e.zIndex=this.layer;e.width="string"===typeof this.width?this.width:this.width+"px";e.height="string"===typeof this.height?this.height:this.height+"px";if(null!==d)for(var f in d)e[f]=d[f];this.invalidate()}var h=f.theatre,i=h.createActor("DOMActor",h.Actor,function(e){this.styles=e.styles||null;this.width=e.width||0;this.height=e.height||0;this.container=e.container||f.document.body;this.listen("enter",
j)});Object.defineProperties(i.prototype,{elementTemplate:{value:document.createElement("div")},act:{value:function(){var e=this.element,d=this.matrix;e.style.webkitTransform="matrix3d("+d.a+","+d.b+",0,0,"+d.c+","+d.d+",0,0,0,0,1,0,"+d.e+","+d.f+",0,1)";this.hasParentNode||(this.hasParentNode=!0,this.parent instanceof i?this.parent.element.appendChild(e):this.container.appendChild(e))}}});h.define("theatre.crews.dom.DOMActor",i)})(this);(function(f){function j(){var d=f.document.createElement("canvas");d.width=this.width||this.parent.width||1;d.height=this.height||this.parent.height||1;this.context=d.getContext("2d");this.invalidate()}var h=f.theatre,i=h.createActor("CanvasActor",h.Actor,function(d){this.width=d.width||0;this.height=d.height||0;this.context=null;this.listen("enter",j)}),e=h.Actor.prototype.invalidate;Object.defineProperties(i.prototype,{draw:{value:function(d){d.clearRect(0,0,this.width,this.height)}},getDrawResult:{value:function(){var d=
this.context;if(!0!==this.isInvalidated)return d.canvas;d.save();this.draw(d);d.restore();for(var e=this.getActors(),a=0,c=e.length;a<c;a++){var b=e[a],f=b.matrix,b=void 0!==b.getDrawResult?b.getDrawResult():null;null!==b&&(d.save(),d.transform(f.a,f.b,f.c,f.d,f.e,f.f),d.drawImage(b,0,0),d.restore())}return d.canvas}},act:{value:function(){var d=this.getDrawResult();!0!==this.isAdded&&(this.isAdded=!0,h.crews.dom&&this.parent instanceof h.crews.dom.DOMActor&&(d.style.zIndex=this.layer,this.parent.element.appendChild(d)))}},
invalidate:{value:function(){e.call(this);this.parent.invalidate()}}});h.define("theatre.crews.canvas.CanvasActor",i)})(this);

/*
 TheatreScript
 Copyright (C) 2012 Jason Parrott.
 This code is licensed under the zlib license.
 See the LICENSE file in the original source for details.
*/
'use strict';(function(e){function g(d,a,c){c||(c=e);for(var f=d.lastIndexOf("."),i=d.substring(f+1),d=d.substring(0,f).split(/\./);f=d.shift();)c=c[f]=c[f]||{};if(void 0!==a)c[i]=a;else return c;return a}function a(){this._completeMap={};this._callbackMap=[];this._runs=[];this._completed=this._remaining=this._status=0}var b=g("theatre",{},e);HTMLCollection.prototype.forEach=NodeList.prototype.forEach=Array.prototype.forEach;void 0===Object.mixin&&(Object.mixin=function(){for(var d=arguments[0]||
{},a=1,c=arguments.length;a<c;a++){var f=arguments[a];if(f)for(var i in f)!0===f.hasOwnProperty(i)&&(d[i]=f[i])}return d});a.prototype={require:function(d,a){var c=true,f=this;d.forEach(function(a){f._completeMap[a]===void 0&&(c=false)});if(c===true)a(e,this);else{this._callbackMap.push([a,d]);this._remaining++}return this},run:function(a){this._status===0?this._runs.push(a):a(e,this);return this},complete:function(a){this._completeMap[a]=true;this._completed++;return this},resolve:function(){this._status=
1;var a=this._callbackMap,b=this._completeMap,c=this,f=[],i=[];for(this._runs.forEach(function(a){a(e,c)});;){var l=this._completed;a.forEach(function(c,a){var d=c[0];if(c[1].every(function(c){return b[c]===void 0?false:true})===true){f.push(d);i.push(a)}});i.forEach(function(c){a.splice(c,1)});i.length=0;f.forEach(function(a){a(e,c);c._remaining--});f.length=0;if(this._remaining===0)break;else if(l===this._completed)throw Error("Could not resolve due to unmet dependancies.");}this._status=2}};var h=
new a;b.run=function(a){h===null?a(e):h.run(function(b){a(b)})};b.require=function(a,b){if(h===null)throw Error("TheatreScript has already started up.");h.require(a,function(c){b(c)})};b.define=function(a,k,c){g(a,k,c);h!==null&&h.complete(a);return b};b.init=function(){h.resolve();h=null};b.define("theatre",b).define("theatre.Resolver",a)})(this);theatre.require(["theatre.Matrix"],function(e){function g(){}function a(c,a,d,b){a=this.stage.timeToStep(a);c in this._scenes?c=this._scenes[c].scripts[b]:(c=this._scenes[c]={isActing:!1,currentStep:0,previousStep:-1,shouldLoop:!0,scripts:[[],[]]},c=c.scripts[b]);c.length<=a?c[a]=[d]:c[a].push(d)}function b(c,a){if(void 0!==c[a]){var d=this;c[a].forEach(function(c){c.call(d)})}}var h=e.theatre,d=h.Matrix,k=e.Math.max;h.define("theatre.Actor",g);h.define("theatre.createActor",function(c,a,d){a||(a=
h.Actor);var c=e.eval("(function "+c+"(){})"),a=c.prototype=new a,b=a.initialize;void 0!==d&&(a.initialize=function(){b.apply(this,arguments);d.apply(this,arguments)});return c});g.prototype={initialize:function(c,a,b,k,j){this.stage=a;this.matrix=new d;this.layer=b;this.parent=k;this.name=j;this.isInvalidated=this.isActing=!1;this._scenes={};this._layerCounter=0},listen:function(c,a){!1==="_cues"in this&&(this._cues={});!1===c in this._cues?(this._cues[c]=[a],this.stage.registerListener(c,this)):
this._cues[c].push(a);return this},ignore:function(a,d){if("_cues"in this&&a in this._cues){var b=this._cues[a];b.some(function(a,c){if(a===d)return b.splice(c,1),!0});0===b.length&&(delete this._cues[a],this.stage.unregisterListener(a,this))}return this},cue:function(a,d){if("_cues"in this&&a in this._cues){var b=this;this._cues[a].slice(0).forEach(function(k){k.call(b,{target:b,data:d,name:a})})}return this},invalidate:function(){if(!0!==this.isInvalidated)return this.isInvalidated=!0,this.stage.invalidate(this),
this},addPreparationScript:function(c,d){a.call(this,pSceneName,c,d,0);return this},addScript:function(c,d,b){a.call(this,c,d,b,1);return this},doScripts:function(a,d,k){function h(){"number"!==typeof d&&(d=tScene.currentStep);void 0===k&&(k=this);b(k,tScene.scripts[1],d)}var j=this._scenes;if(a){if("string"===typeof a){if(!1===a in j)throw Error("Scene doesn't exist: "+a);h(j[a].scripts[1])}}else for(tName in j)h(j[tName].scripts[1])},startActing:function(){this.stage.activateActor(this);this.isActing=
!0;return this},stopActing:function(){this.stage.deactivateActor(this);this.isActing=!1;return this},gotoInScene:function(a,d){if(!1===a in this._scenes)throw Error("Scene doesn't exist: "+a);var b=this._scenes[a],d=this.stage.timeToStep(d);this.step(d-b.currentStep,b,!1);return this},startActingScene:function(a){if(!1===a in this._scenes)throw Error("Scene doesn't exist: "+a);this._scenes[a].isActing=!0;return this},stopActingScene:function(a){if(!1===a in this._scenes)throw Error("Scene doesn't exist: "+
a);this._scenes[a].isActing=!1;return this},act:function(){},step:function(a,d,i){function h(d){if(!1!==d.isActing){var f=d.currentStep,e=d.scripts,g=k(e[0].length,e[1].length),l=d.currentStep+=a,m=!1;if(l>=g){if(!1===j.shouldLoop||1===g){d.currentStep=g-1;return}l=d.currentStep-=g;m=!0}if(f===l)!0===m&&!i&&(b(j,pScripts[0],l),b(j,pScripts[1],l));else{if(!(0>a||!0===m)){f+=1;for(g=l;f<=g;f++)d.currentStep=f,b(j,e[0],f)}i||b(j,e[1],l)}}}var j=this,e=this._scenes;if(d){if("string"===typeof d){if(!1===
d in e)throw Error("Scene doesn't exist: "+d);h(e[d])}}else for(tName in e)h(e[tName]);i||this.cue("update")},addActor:function(a,d){var d=Object.mixin({data:null},d),b="number"===typeof d.layer?d.layer:this._layerCounter++,k;k=!1==="_actors"in this?this._actors=Array(b+1):this._actors;if(void 0!==k[b])throw Error("Actor already exists at layer "+b);var e=new a,h="string"!==typeof d.name?d.name:"instance"+tStage._actorNameCounter++;e.initialize(d.data,this.stage,b,this,h);k[b]=e;e.cue("enter");return e},
leave:function(){null===this.parent||this.parent._actors[this.layer]!==this||(this.cue("leave"),this.stage.deactivateActor(this),this.parent._actors[this.layer]=void 0)},get x(){return this.matrix.x},set x(a){this.matrix.x=a},get y(){return this.matrix.y},set y(a){this.matrix.y=a},get rotation(){return this.matrix.rotation},set rotation(a){this.matrix.rotation=a},get scaleX(){return this.matrix.sx},set scaleX(a){this.matrix.sx=a},get scaleY(){return this.matrix.sy},set scaleY(a){this.matrix.sy=a}}});theatre.require(["theatre.Actor"],function(e){var e=e.theatre,g=e.createActor("StageManager");e.define("theatre.StageManager",g)});theatre.run(function(e){function g(a){var b=Date.now();a.step();a.isOpen&&(a.timer=setTimeout(g,a.stepRate-(Date.now()-b),a))}function a(){this._timer=null;this._actingActors=[];this._listeners={};this._invalidatedActors=[];this._actorNameCounter=1;this.stepRate=1E3/30;this.isOpen=!1;var a;Object.defineProperty(this,"stageManager",{get:function(){return a},set:function(b){a=b;b.initialize(null,this);b.isActing=!0;this.activateActor(b,!0)}});this.stageManager=new b.StageManager}var b=e.theatre;b.define("theatre.Stage",
a);var h=/^([\d]+)(ms|[sm])$/;a.prototype={timeToStep:function(a){if("number"===typeof a)return a;a=h.exec(a);if(null===a)throw Error("Bad time string");switch(a[2]){case "ms":return a[1]/this.stepRate|0;case "s":return 1E3*a[1]/this.stepRate|0;case "m":return 6E4*a[1]/this.stepRate|0}},open:function(){this.isOpen=!0;this.timer=setTimeout(g,this.stepRate,this);return this},close:function(){clearTimeout(this.timer);this.timer=null;this.isOpen=!1;return this},invalidate:function(a){this._invalidatedActors.push(a)},
step:function(){this.cue("enterstep");for(var a=this._actingActors.slice(0),b,c=b=a.length;0!==c--;){var f=a[c];f.forEach(function(a){a.step(1,null,!0)})}for(c=b;0!==c--;)f=a[c],f.forEach(function(a){a.doScripts()});this.cue("update");a=this._invalidatedActors;a.forEach(function(a){a.act();a.isInvalidated=!1});a.length=0;this.cue("leavestep")},activateActor:function(a,b){for(var c=a.parent,f=0;null!=c;)f++,c=c.parent;c=this._actingActors;c=c.length<=f?c[f]=[]:c[f];-1===c.indexOf(a)&&(c.push(a),b||
a.step(1))},deactivateActor:function(a){for(var b=pReel.parent,c=0;null!=b;)c++,b=b.parent;b=this._actingActors;void 0!==b[c]&&(a=b[c].indexOf(a),0<=a&&b.splice(a,1))},setBackground:function(a){this.background=a},registerListener:function(a,b){a in this._listeners?this._listeners[a].push(b):this._listeners[a]=[b]},unregisterListener:function(a,b){if(a in this._listeners){var c=this._listeners[a];c.some(function(a,d){if(a===b)return c.splice(d,1),!0});0===c.length&&delete this._listeners[a]}},cue:function(a,
b){a in this._listeners&&this._listeners[a].slice(0).forEach(function(c){c.cue(a,b)})}}});theatre.run(function(e){function g(a,b,e,d,g,c){void 0!==a&&"number"!==typeof a&&a.__proto__===Array.prototype?this.concat(a):(this[0]="number"!==typeof a?1:a,this[1]="number"!==typeof b?0:b,this[2]="number"!==typeof e?0:e,this[3]="number"!==typeof d?1:d,this[4]="number"!==typeof g?0:g,this[5]="number"!==typeof c?0:c);this._rotation=0}e.theatre.define("theatre.Matrix",g);g.prototype=[];Object.defineProperties(g.prototype,{x:{get:function(){return this[4]},set:function(a){this.translateTo(a,null)}},
y:{get:function(){return this[5]},set:function(a){this.translateTo(null,a)}},rotation:{get:function(){return this._rotation},set:function(a){var b=this.slice(0);this.identity().scale(b[0],b[3]).rotate(a).translate(b[4],b[5]);this._rotation=a}},scaleX:{get:function(){return this[0]},set:function(a){this[0]=a}},scaleY:{get:function(){return this[3]},set:function(a){this[3]=a}},clone:{value:function(){return new g(this[0],this[1],this[2],this[3],this[4],this[5])}},add:{value:function(a){var b=this.splice(0,
6);this.push(b[0]+a[0],b[1]+a[1],b[2]+a[2],b[3]+a[3],b[4]+a[4],b[5]+a[5]);return this}},concat:{value:function(a){var b=this[0],e=this[1],d=this[2],g=this[3],c=this[4],f=this[5],i=a[0],l=a[1],j=a[2],m=a[3],n=a[4],a=a[5];this.length=0;this.push(Math.round(1E15*(b*i+e*j))/1E15,Math.round(1E15*(b*l+e*m))/1E15,Math.round(1E15*(d*i+g*j))/1E15,Math.round(1E15*(d*l+g*m))/1E15,Math.round(1E15*(c*i+f*j+n))/1E15,Math.round(1E15*(c*l+f*m+a))/1E15);return this}},translate:{value:function(a,b){this.concat([1,
0,0,1,a,b]);return this}},translateTo:{value:function(a,b){"number"===typeof a&&(this[4]=a);"number"===typeof b&&(this[5]=b);return this}},rotate:{value:function(a){var b=Math.round(1E15*Math.sin(a))/1E15,a=Math.round(1E15*Math.cos(a))/1E15;this.concat([a,b,-b,a,0,0]);return this}},scale:{value:function(a,b){this.concat([a,0,0,b,0,0]);return this}},skew:{value:function(a,b){this.concat([1,b,a,1,0,0]);return this}},identity:{value:function(){this.length=0;this.push(1,0,0,1,0,0);return this}},inverse:{value:function(){var a=
this.splice(0,6),b=1/(a[0]*a[3]-a[1]*a[2]);this.length=6;this[0]=b*a[3];this[1]=-b*a[1];this[2]=-b*a[2];this[3]=b*a[0];this[4]=b*(a[2]*a[5]-a[3]*a[4]);this[5]=b*(a[1]*a[4]-a[0]*a[5]);return this}},getPoint:{value:function(a,b){return{x:Math.round(1E15*(a*this[0]+b*this[2]+this[4]))/1E15,y:Math.round(1E15*(a*this[1]+b*this[3]+this[5]))/1E15}}},_toString:{value:function(){return this.join(", ")}}})});;theatre.init();

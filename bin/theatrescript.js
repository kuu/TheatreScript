'use strict';function use(){};/*
 TheatreScript
 Copyright (C) 2012 Jason Parrott.
 This code is licensed under the zlib license.
 See the LICENSE file in the original source for details.
*/
(function(e){function i(j,g,a){a||(a=e);for(var c=j.lastIndexOf("."),b=j.substring(c+1),j=j.substring(0,c).split(/\./);c=j.shift();)a=a[c]=a[c]||{};if(void 0!==g)a[b]=g;else return a;return g}var k=i("theatre",{},e);void 0===Object.mixin&&(Object.mixin=function(){for(var j=arguments[0]||{},e=1,a=arguments.length;e<a;e++){var c=arguments[e];if(c)for(var b in c)!0===c.hasOwnProperty(b)&&(j[b]=c[b])}return j});k.define=function(e,g,a){i(e,g,a);return k}})(this);use("Theatre");(function(e){e.theatre.define("theatre.Matrix","undefined"!==typeof CSSMatrix?CSSMatrix:WebKitCSSMatrix)})(this);use("Theatre","Matrix");
(function(e){function i(){}function k(b,f,a,c){f=this.stage.timeToStep(f);b in this._scenes?b=this._scenes[b].scripts[c]:(b=this._scenes[b]={isActing:!1,currentStep:0,previousStep:-1,shouldLoop:!0,scripts:[[],[]]},b=b.scripts[c]);b.length<=f?b[f]=[a]:b[f].push(a)}function j(b,a){if(void 0!==b[a])for(var c=b[a],d=0,h=c.length;d<h;d++)c[d].call(this)}var g=e.theatre,a=g.Matrix,c=e.Math.max;g.define("theatre.Actor",i);g.define("theatre.createActor",function(b,a,c){a||(a=g.Actor);var b=e.eval("(function "+
b+"(){})"),a=b.prototype=new a,d=a.initialize;void 0!==c&&(a.initialize=function(){d.apply(this,arguments);c.apply(this,arguments)});return b});i.prototype={initialize:function(b,f,c,d,h){this.stage=f;this.matrix=new a;this.layer=c;this.parent=d;this.name=h;this.isInvalidated=this.isActing=!1;this._scenes={};this._layerCounter=0},listen:function(b,a){!1==="_cues"in this&&(this._cues={});!1===b in this._cues?(this._cues[b]=[a],this.stage.registerListener(b,this)):this._cues[b].push(a);return this},
ignore:function(b,a){if("_cues"in this&&b in this._cues){for(var c=this._cues[b],d=0,h=c.length;d<h;d++)if(c[d]===a){c.splice(d,1);break}0===c.length&&(delete this._cues[b],this.stage.unregisterListener(b,this))}return this},cue:function(b,a){if("_cues"in this&&b in this._cues)for(var c=this._cues[b].slice(0),d=0,h=c.length;d<h;d++)c[d].call(this,{target:this,data:a,name:b});return this},invalidate:function(){if(!0!==this.isInvalidated)return this.isInvalidated=!0,this.stage.invalidate(this),this},
addPreparationScript:function(b,a){k.call(this,pSceneName,b,a,0);return this},addScript:function(b,a,c){k.call(this,b,a,c,1);return this},doScripts:function(b,a,c){function d(){"number"!==typeof a&&(a=tScene.currentStep);void 0===c&&(c=this);j(c,tScene.scripts[1],a)}var h=this._scenes;if(b){if("string"===typeof b){if(!1===b in h)throw Error("Scene doesn't exist: "+b);d(h[b].scripts[1])}}else for(tName in h)d(h[tName].scripts[1])},startActing:function(){this.stage.activateActor(this);this.isActing=
!0;return this},stopActing:function(){this.stage.deactivateActor(this);this.isActing=!1;return this},gotoInScene:function(b,a){if(!1===b in this._scenes)throw Error("Scene doesn't exist: "+b);var c=this._scenes[b],a=this.stage.timeToStep(a);this.step(a-c.currentStep,c,!1);return this},startActingScene:function(b){if(!1===b in this._scenes)throw Error("Scene doesn't exist: "+b);this._scenes[b].isActing=!0;return this},stopActingScene:function(b){if(!1===b in this._scenes)throw Error("Scene doesn't exist: "+
b);this._scenes[b].isActing=!1;return this},act:function(){},step:function(b,a,e){function d(a){if(!1!==a.isActing){var f=a.currentStep,d=a.scripts,g=c(d[0].length,d[1].length),i=a.currentStep+=b,k=!1;if(i>=g){if(!1===h.shouldLoop||1===g){a.currentStep=g-1;return}i=a.currentStep-=g;k=!0}if(f===i)!0===k&&!e&&(j(h,pScripts[0],i),j(h,pScripts[1],i));else{if(!(0>b||!0===k)){f+=1;for(g=i;f<=g;f++)a.currentStep=f,j(h,d[0],f)}e||j(h,d[1],i)}}}var h=this,g=this._scenes;if(a){if("string"===typeof a){if(!1===
a in g)throw Error("Scene doesn't exist: "+a);d(g[a])}}else for(tName in g)d(g[tName]);e||this.cue("update")},addActor:function(a,c){var c=Object.mixin({data:null},c),e="number"===typeof c.layer?c.layer:this._layerCounter++,d;d=!1==="_actors"in this?this._actors=Array(e+1):this._actors;if(void 0!==d[e])throw Error("Actor already exists at layer "+e);var h=new a,g="string"!==typeof c.name?c.name:"instance"+tStage._actorNameCounter++;h.initialize(c.data,this.stage,e,this,g);d[e]=h;h.cue("enter");return h},
leave:function(){null!==this.parent&&this.parent._actors[this.layer]===this&&(this.cue("leave"),this.stage.deactivateActor(this),this.parent._actors[this.layer]=void 0)},get x(){return this.matrix.e},set x(a){this.matrix.e=a},get y(){return this.matrix.f},set y(a){this.matrix.f=a},get rotation(){return this._rotation},set rotation(a){this._rotation=a;this.matrix=this.matrix.rotateAxisAngle(0,0,0,a)},get scaleX(){return this.matrix.a},set scaleX(a){this.matrix=this.matrix.scale(a,0)},get scaleY(){return this.matrix.d},
set scaleY(a){this.matrix=this.matrix.scale(0,a)}}})(this);use("Theatre","Actor");(function(e){var e=e.theatre,i=e.createActor("StageManager");e.define("theatre.StageManager",i)})(this);use("Theatre","StageManager");
(function(e){function i(a){var c=Date.now();a.step();a.isOpen&&(a.timer=setTimeout(i,a.stepRate-(Date.now()-c),a))}function k(){this._animationFrameId=this._timer=null;this._actingActors=[];this._listeners={};this._invalidatedActors=[];this._actorNameCounter=1;this.stepRate=1E3/30;this.isOpen=!1;var a;Object.defineProperty(this,"stageManager",{get:function(){return a},set:function(c){a=c;c.initialize(null,this);c.isActing=!0;this.activateActor(c,!0)}});this.stageManager=new j.StageManager}var j=e.theatre;
j.define("theatre.Stage",k);var g=/^([\d]+)(ms|[sm])$/;k.prototype={timeToStep:function(a){if("number"===typeof a)return a;a=g.exec(a);if(null===a)throw Error("Bad time string");switch(a[2]){case "ms":return a[1]/this.stepRate|0;case "s":return 1E3*a[1]/this.stepRate|0;case "m":return 6E4*a[1]/this.stepRate|0}},open:function(){this.isOpen=!0;this.timer=setTimeout(i,this.stepRate,this);return this},close:function(){clearTimeout(this.timer);this.timer=null;this.isOpen=!1;return this},invalidate:function(a){this._invalidatedActors.push(a)},
step:function(){var a,c,b;this.cue("enterstep");for(var f=this._actingActors.slice(0),g,d=g=f.length;0!==d--;){b=f[d];a=0;for(c=b.length;a<c;a++)b[a].step(1,null,!0)}for(d=g;0!==d--;){b=f[d];a=0;for(c=b.length;a<c;a++)b[a].doScripts()}this.cue("update");null===this._animationFrameId&&0!==this._invalidatedActors.length&&(this._animationFrameId=e.webkitRequestAnimationFrame(function(a){return function(){a._animationFrameId=null;for(var b=a._invalidatedActors,c=0,d=b.length;c<d;c++){var f=b[c];f.act();
f.isInvalidated=!1}b.length=0}}(this)));this.cue("leavestep")},activateActor:function(a,c){for(var b=a.parent,f=0;null!=b;)f++,b=b.parent;b=this._actingActors;b=b.length<=f?b[f]=[]:b[f];-1===b.indexOf(a)&&(b.push(a),c||a.step(1))},deactivateActor:function(a){for(var c=pReel.parent,b=0;null!=c;)b++,c=c.parent;c=this._actingActors;void 0!==c[b]&&(a=c[b].indexOf(a),0<=a&&c.splice(a,1))},setBackground:function(a){this.background=a},registerListener:function(a,c){a in this._listeners?this._listeners[a].push(c):
this._listeners[a]=[c]},unregisterListener:function(a,c){if(a in this._listeners){for(var b=this._listeners[a],f=0,e=b.length;f<e;f++)if(b[f]===c){b.splice(f,1);break}0===b.length&&delete this._listeners[a]}},cue:function(a,c){if(a in this._listeners)for(var b=this._listeners[a].slice(0),f=0,e=b.length;f<e;f++)b[f].cue(a,c)}}})(this);
